from SignalLib import *

def func(d, w1, w2):
    """
    â€œæŠ€æœ¯åˆ†æžç³»æ‹¥æŠ±é€‰è‚¡å› å­â€ç³»åˆ—ç ”ç©¶ï¼ˆä¸ƒï¼‰ï¼šé‡ç¨³æ¢æ‰‹çŽ‡é€‰è‚¡å› å­ï¼šé‡å°ã€é‡ç¼©ï¼Œéƒ½ä¸å¦‚é‡ç¨³ï¼Ÿ_2021-05-16_ä¸œå´è¯åˆ¸
    æœ¬èŠ‚å†…å®¹ï¼Œæˆ‘ä»¬ç»§ç»­åˆ©ç”¨æ—¥é¢‘æ•°æ®ï¼Œä»Žè€ƒå¯Ÿâ€œæ—¥é¢‘æ¢æ‰‹çŽ‡ç¨³å®šæ€§â€çš„è§’åº¦ï¼Œæž„é€ é€‰è‚¡å› å­ã€‚å…·ä½“æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š
    ï¼ˆ1ï¼‰æ¯æœˆæœˆåº•ï¼Œå›žæº¯æ¯åªè‚¡ç¥¨è¿‡åŽ» 20 ä¸ªäº¤æ˜“æ—¥ï¼Œè®¡ç®—å…¶ 20 æ—¥æ¢æ‰‹çŽ‡çš„æ ‡å‡†å·®ï¼›
    ï¼ˆ2ï¼‰åœ¨æ¨ªæˆªé¢ä¸Šåšå¸‚å€¼ä¸­æ€§åŒ–å¤„ç†ï¼Œå³å¾—åˆ°æ‰€æœ‰è‚¡ç¥¨å½“æœˆçš„å› å­å€¼ï¼Œè®°ä¸ºé‡ç¨³æ¢æ‰‹çŽ‡å› å­ STRï¼ˆå³æ¢æ‰‹çŽ‡çš„ç¨³å®šæ€§ï¼ŒThe Stability of Turnover Rateï¼‰
    ====================================================================================================================
    æ—¥å†…äº¤æ˜“ç‰¹å¾ç¨³å®šæ€§ä¸Žè‚¡ç¥¨æ”¶ç›Šâ€”â€”å› å­é€‰è‚¡ç³»åˆ—ä¹‹å››åä¹-ä¸œæ–¹è¯åˆ¸
    7 ä¸ªæ—¥å†…äº¤æ˜“ç‰¹å¾ç¨³å®šæ€§å› å­åœ¨å„ä¸ªæ ·æœ¬ç©ºé—´å‡å±•çŽ°å‡ºæ—¥å†…äº¤æ˜“ç‰¹å¾ç¨³å®šæ€§
    è¶Šå·®çš„è‚¡ç¥¨æœªæ¥å¹³å‡æ”¶ç›Šè¶Šä½Žçš„é€‰è‚¡æ•ˆæžœ
    æˆ‘ä»¬å¯ä»¥è®¡ç®—æ—¥å†… 5åˆ†é’Ÿæˆäº¤é‡çš„æ³¢åŠ¨çŽ‡ð‘‰ð‘‰ð‘‚ð¿ð‘–,ð‘¡
    é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜é€šè¿‡èµ«èŠ¬è¾¾å°”â€”èµ«å¸Œæ›¼æŒ‡æ•°(Herfindahl-Hirschman Indexï¼Œç®€ç§° HHIï¼‰è€ƒå¯Ÿäº†æ—¥å†…æˆäº¤é‡åœ¨ä¸åŒäº¤æ˜“æ—¶é—´åˆ†å¸ƒçš„ç¦»æ•£ç¨‹åº¦
    æˆ‘ä»¬é‡‡ç”¨ (å…¶å¯¦æ²’æœ‰) Newey West è°ƒæ•´åŽçš„æ ‡å‡†å·®åº¦é‡è‚¡ç¥¨åœ¨è¿‡åŽ»ä¸€æ®µæ—¶é—´å†…çš„ç¨³å®šæ€§
    Parameters
    ----------
    d :
    w1 : ç¬¬ä¸€å€‹ STD çª—å£
    w2 : ç¬¬äºŒå€‹ STD çª—å£

    Returns
    -------

    """

    v = d['v']
    # ==================================================================================================================
    # STR
    STR = ta.STDDEV(v, w2)
    # ==================================================================================================================
    # PctTurn
    PctTurn = np.nan_to_num((ta.MA(v, w1) / shift(ta.MA(v, w1), w2)) - 1, nan=0, posinf=0, neginf=0)
    # ==================================================================================================================
    # èµ«èŠ¬è¾¾å°”â€”èµ«å¸Œæ›¼æŒ‡æ•°(Herfindahl-Hirschman Indexï¼Œç®€ç§° HHIï¼‰
    # VHHI = ta.SUM(np.power(np.where(sub := ta.SUM(v, w1) > 0, v / sub, 0), 2), w1)
    # res1 = ta.STDDEV(STR, w2)
    # res2 = ta.STDDEV(ffill(VHHI), w2)

    return PctTurn, STR #, res1, res2


if __name__ == '__main__':
    for ns in [[20, 20], [20, 50], [20, 100], [50, 50], [50, 80], [50, 100], [50, 200]]:
        res = run_test(func, *ns, w=5)
